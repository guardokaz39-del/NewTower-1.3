# Ð ÑƒÐºÐ¾Ð²Ð¾Ð´ÑÑ‚Ð²Ð¾ Ð¿Ð¾ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸ÑŽ (Vitest)

Ð’ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ð° Ð¸Ð½Ñ„Ñ€Ð°ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð¾Ð³Ð¾ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ð½Ð° Ð±Ð°Ð·Ðµ **Vitest** (Ñ `jsdom`). Ð Ð°Ð½ÐµÐµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð»ÑÑ Jest, Ð½Ð¾ Ð¿Ñ€Ð¾ÐµÐºÑ‚ Ð¼Ð¸Ð³Ñ€Ð¸Ñ€Ð¾Ð²Ð°Ð» Ð½Ð° Vitest Ð´Ð»Ñ Ð»ÑƒÑ‡ÑˆÐµÐ¹ Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ð¸ Ñ Vite Ð¸ ÑƒÐ²ÐµÐ»Ð¸Ñ‡ÐµÐ½Ð¸Ñ ÑÐºÐ¾Ñ€Ð¾ÑÑ‚Ð¸ ÑÐ±Ð¾Ñ€ÐºÐ¸.
Ð¢ÐµÑÑ‚Ñ‹ Ð¿Ñ€ÐµÐ´Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½Ñ‹ Ð´Ð»Ñ Ð·Ð°Ñ‰Ð¸Ñ‚Ñ‹ "ÑˆÐ²Ð¾Ð²" Ð°Ñ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ñ‹, Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð¼Ð°Ñ‚ÐµÐ¼Ð°Ñ‚Ð¸ÐºÐ¸ (ÑÑ‚Ð°Ñ‚ÑƒÑÑ‹, ÑƒÑ€Ð¾Ð½) Ð¸ Ñ†ÐµÐ»Ð¾ÑÑ‚Ð½Ð¾ÑÑ‚Ð¸ Ð¼Ð°ÑÑÐ¸Ð²Ð¾Ð² (hot-path Ñ†Ð¸ÐºÐ»Ñ‹).

## ðŸš€ Ð—Ð°Ð¿ÑƒÑÐº Ñ‚ÐµÑÑ‚Ð¾Ð² Ñ‡ÐµÑ€ÐµÐ· CMD

Ð”Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ Ð² Ñ‚ÐµÑ€Ð¼Ð¸Ð½Ð°Ð»Ðµ:

1. **Ð—Ð°Ð¿ÑƒÑÐº Ð²ÑÐµÑ… Ñ‚ÐµÑÑ‚Ð¾Ð²:**

   ```bash
   npm run test
   ```

   *Ð˜Ð»Ð¸ Ð½Ð°Ð¿Ñ€ÑÐ¼ÑƒÑŽ Ñ‡ÐµÑ€ÐµÐ· npx:*

   ```bash
   npx vitest run
   ```

2. **Ð—Ð°Ð¿ÑƒÑÐº ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ð¾Ð³Ð¾ Ñ‚ÐµÑÑ‚Ð¾Ð²Ð¾Ð³Ð¾ Ñ„Ð°Ð¹Ð»Ð° (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, combat):**

   ```bash
   npx vitest run __tests__/combat.test.ts
   ```

3. **Ð—Ð°Ð¿ÑƒÑÐº Ñ‚ÐµÑÑ‚Ð¾Ð² Ð² Ñ€ÐµÐ¶Ð¸Ð¼Ðµ Watch (Ð½Ð°Ð±Ð»ÑŽÐ´ÐµÐ½Ð¸Ñ):**

   ```bash
   npm run test:watch
   ```

## ðŸ“‚ Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° Ñ‚ÐµÑÑ‚Ð¾Ð²Ð¾Ð³Ð¾ Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð¸Ñ

Ð’ÑÐµ Ñ‚ÐµÑÑ‚Ñ‹ Ð½Ð°Ñ…Ð¾Ð´ÑÑ‚ÑÑ Ð² ÐºÐ¾Ñ€Ð½ÐµÐ²Ð¾Ð¹ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ `__tests__/`.

| Ð¤Ð°Ð¹Ð» | ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð¿Ð¾ÐºÑ€Ñ‹Ð²Ð°ÐµÐ¼Ð¾Ð¹ Ð»Ð¾Ð³Ð¸ÐºÐ¸ |
| --- | --- |
| `Enemy.test.ts` | Ð¡Ñ‚Ð°ÐºÐ¸ ÑÑ„Ñ„ÐµÐºÑ‚Ð¾Ð² (Slow), Ð·Ð°Ñ‰Ð¸Ñ‚Ð° Ð¾Ñ‚ Ð´Ð²Ð¾Ð¹Ð½Ñ‹Ñ… Ñ‚Ñ€Ð¸Ð³Ð³ÐµÑ€Ð¾Ð² ÑÐ¼ÐµÑ€Ñ‚Ð¸ Ð¿Ñ€Ð¸ DoT (Burn) |
| `Tower.test.ts` | ÐœÐ°Ñ‚ÐµÐ¼Ð°Ñ‚Ð¸ÐºÐ° ÐºÐ°Ð»ÑŒÐºÑƒÐ»ÑÑ†Ð¸Ð¸ ÐºÐ°Ñ€Ñ‚Ð¾Ñ‡ÐµÐº (`mergeCardsWithStacking`), Ð»Ð¾Ð³Ð¸ÐºÐ° Ð²Ñ‹Ð±Ð¾Ñ€ÐºÐ¸ Ñ†ÐµÐ»Ð¸ (`TargetingSystem`) |
| `ProjectileSystem.test.ts`| Ð‘ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚ÑŒ Ð¿ÑƒÐ»Ð¸Ð½Ð³Ð° Ð¸ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ Ð¿ÑƒÐ»ÑŒ (swap & pop Ð±ÐµÐ· Ð¿Ð¾Ñ‚ÐµÑ€Ð¸ Ð¸Ð½Ð´ÐµÐºÑÐ¾Ð²) |
| `CollisionSystem.test.ts` | Ð—Ð°Ñ‰Ð¸Ñ‚Ð° Ð¾Ñ‚ Ñ€ÐµÐºÑƒÑ€ÑÐ¸Ð²Ð½Ñ‹Ñ… CallStack/RangeError-Ð¾ÑˆÐ¸Ð±Ð¾Ðº Ð¿Ñ€Ð¸ Ð¼Ð°ÑÑÐ¾Ð²Ñ‹Ñ… ÑÐ¿Ð»ÐµÑˆ-Ð²Ð·Ñ€Ñ‹Ð²Ð°Ñ… |
| `FlowField.test.ts` | Ð’Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ Ð°Ð»Ð³Ð¾Ñ€Ð¸Ñ‚Ð¼Ð° Ð”ÐµÐ¹ÐºÑÑ‚Ñ€Ñ‹ (Ð¾Ð±Ñ…Ð¾Ð´ ÑÑ‚ÐµÐ½) Ð¸ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾ÑÑ‚ÑŒ Ð½Ð¾Ñ€Ð¼Ð°Ð»Ð¸Ð·Ð¾Ð²Ð°Ð½Ð½Ñ‹Ñ… Ð²ÐµÐºÑ‚Ð¾Ñ€Ð¾Ð² Ð½Ð°Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ð¹ |
| `SaveManager.test.ts` | ÐÐºÐºÑƒÐ¼ÑƒÐ»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð½Ð°ÐºÐ¾Ð¿Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ð¹ Ð´ÐµÐ»ÑŒÑ‚Ñ‹ (kills, money) Ð¿Ñ€Ð¸ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸ÑÑ… |
| `WaveManager.test.ts` | Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ð¹ Ð²Ð¾Ð»Ð½Ñ‹, Ñ‚Ñ€ÐµÐºÐ¸Ð½Ð³ ÑÑ‚ÐµÐ¹Ñ‚Ð° Ñ€Ð°Ð½Ð½Ð¸Ñ… ÑÑ‚Ð°Ñ€Ñ‚Ð¾Ð² |
| `EventBus.test.ts` | Ð—Ð°Ñ‰Ð¸Ñ‚Ð° Ð¾Ñ‚ ÑƒÑ‚ÐµÑ‡ÐµÐº Ð¿Ð°Ð¼ÑÑ‚Ð¸ (Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ¾Ðº Ð¸ Ð¾Ñ‚Ð¿Ð¸ÑÐ¾Ðº) |
| `StressLogger.test.ts` | ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ€Ð°ÑÑ‡Ñ‘Ñ‚Ð° Ð¼Ð°Ñ‚ÐµÐ¼Ð°Ñ‚Ð¸ÐºÐ¸ ÐºÐ°Ð´Ñ€Ð¾Ð² (percentiles) Ð±ÐµÐ· Ð´ÐµÐ»ÐµÐ½Ð¸Ñ Ð½Ð° 0 Ð¿Ñ€Ð¸ Ð¿ÑƒÑÑ‚Ñ‹Ñ… Ð¿Ñ€Ð¾Ñ…Ð¾Ð´Ð°Ñ… (P0) |
| `PerformanceProfiler.test.ts` | ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° `SAMPLE_RATE` Ð¸ ÑÐ±Ð¾Ñ€Ð° ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸ Ð¿Ð¾ Ñ„Ñ€ÐµÐ¹Ð¼Ð°Ð¼ |
| `combat.test.ts` | Ð˜Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ð¾Ð½Ð½Ñ‹Ð¹ end-to-end Ð¿Ð°Ð¹Ð¿Ð»Ð°Ð¹Ð½ Ð¿Ñ€Ð¸ `dt = 1/60`. Ð¡Ð¸Ð¼ÑƒÐ»ÑÑ†Ð¸Ñ `WeaponSystem`, `TargetingSystem`, `CollisionSystem` |

## ðŸ› ï¸ ÐœÐ¾ÐºÐ¸Ð½Ð³ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ (Canvas Ð¸ Environment)

ÐœÐ½Ð¾Ð³Ð¸Ðµ ÐºÐ»Ð°ÑÑÑ‹ (Tower, Enemy) ÑÐ¾Ð´ÐµÑ€Ð¶Ð°Ñ‚ ÑÑÑ‹Ð»ÐºÐ¸ Ð½Ð° Ð¼ÐµÑ‚Ð¾Ð´Ñ‹ `ctx` Ð¸Ð»Ð¸ `Image` Ð´Ð»Ñ Ñ€ÐµÐ½Ð´ÐµÑ€Ð¸Ð½Ð³Ð°, Ð° Ð½ÐµÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹ (Ð½Ð°Ð¿Ñ€. `CollisionSystem`) Ð·Ð°Ð²Ð¸ÑÑÑ‚ Ð¾Ñ‚ Ð¾Ð±ÑŠÐµÐºÑ‚Ð° `window`.
Ð’ `__tests__/setup.ts` Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ñ‹ Ð±Ð°Ð·Ð¾Ð²Ñ‹Ðµ Ð·Ð°Ð³Ð»ÑƒÑˆÐºÐ¸ `HTMLCanvasElement.prototype.getContext`, Ð³Ð»Ð¾Ð±Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ `Image` Ð¸ `performance.memory`. ÐŸÑ€Ð¸ Ð½Ð°Ð¿Ð¸ÑÐ°Ð½Ð¸Ð¸ Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ð¾Ð½Ð½Ñ‹Ñ… Ñ‚ÐµÑÑ‚Ð¾Ð² Ñ Ð¾Ñ‚Ñ€Ð¸ÑÐ¾Ð²ÐºÐ¾Ð¹ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ Ð¼Ð¾ÐºÐ¸ Canvas API.

> **Ð’Ð½Ð¸Ð¼Ð°Ð½Ð¸Ðµ, JSDOM!** Ð’ ÑÑ€ÐµÐ´Ðµ `jsdom` Ð³Ð»Ð¾Ð±Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ `window.innerWidth` Ð¸ `window.innerHeight` Ð¼Ð¾Ð³ÑƒÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ñ€Ð°Ð²Ð½Ñ‹ Ð½ÑƒÐ»ÑŽ Ð¸Ð»Ð¸ Ð½Ðµ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹. `SpatialGrid` Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÑ‚ÑÑ, Ð¾Ð¿Ð¸Ñ€Ð°ÑÑÑŒ Ð½Ð° Ñ€Ð°Ð·Ð¼ÐµÑ€ Ð¾ÐºÐ½Ð°. Ð•ÑÐ»Ð¸ Ð² Ñ‚ÐµÑÑ‚Ð°Ñ… Ð²Ñ€Ð°Ð³Ð¸ Ð½Ðµ Ð¿Ð¾Ð¿Ð°Ð´Ð°ÑŽÑ‚ Ð² Ñ€Ð°Ð´Ð¸ÑƒÑ Ð°Ñ‚Ð°ÐºÐ¸, ÑƒÐ±ÐµÐ´Ð¸Ñ‚ÐµÑÑŒ, Ñ‡Ñ‚Ð¾ Ð²Ñ‹ Ð·Ð°Ð¼Ð¾ÐºÐ°Ð»Ð¸ Ñ€Ð°Ð·Ð¼ÐµÑ€Ñ‹ Ð¾ÐºÐ½Ð° *Ð´Ð¾* Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸ `CollisionSystem`:
>
> ```typescript
> Object.defineProperty(window, 'innerWidth', { writable: true, configurable: true, value: 1024 });
> Object.defineProperty(window, 'innerHeight', { writable: true, configurable: true, value: 768 });
> ```

## âš”ï¸ Ð˜Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ð¾Ð½Ð½Ð¾Ðµ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ (Combat)

Ð”Ð»Ñ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ ÐºÐ¾Ð¼Ð¿Ð»ÐµÐºÑÐ½Ñ‹Ñ… Ñ†ÐµÐ¿Ð¾Ñ‡ÐµÐº Ð±ÐµÐ· Canvas Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ `__tests__/combat.test.ts`.
Ð’Ð°Ð¶Ð½Ð¾: Ð±Ð°ÑˆÐ½Ñ Ð½Ðµ ÑÑ‚Ñ€ÐµÐ»ÑÐµÑ‚ ÑÐ°Ð¼Ð° Ð¿Ð¾ ÑÐµÐ±Ðµ Ð² `update`. ÐžÐ½Ð° Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð½Ð°Ð²Ð¾Ð´Ð¸Ñ‚ÑÑ (`TargetingSystem`). Ð¡Ñ‚Ñ€ÐµÐ»ÑŒÐ±Ð° Ð¸ ÑÐ¿Ð°Ð²Ð½ Ð¿ÑƒÐ»ÑŒ Ð¿Ñ€Ð¾Ð¸ÑÑ…Ð¾Ð´Ð¸Ñ‚ Ð¸ÑÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð²Ð½ÑƒÑ‚Ñ€Ð¸ `WeaponSystem.update()`. `dt` Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð¼Ð°Ð»Ñ‹Ð¼ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, `1/60`), Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¸Ð·Ð±ÐµÐ¶Ð°Ñ‚ÑŒ Ñ‚ÑƒÐ½Ð½ÐµÐ»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ (Ð¿Ñ€Ð¾Ð»ÐµÑ‚Ð°Ð½Ð¸Ñ Ð¿ÑƒÐ»Ð¸ ÑÐºÐ²Ð¾Ð·ÑŒ Ð²Ñ€Ð°Ð³Ð°).

## ðŸ›¡ï¸ Minimum Viable Testing (MVT) Ð´Ð»Ñ Ð¼ÐµÑ…Ð°Ð½Ð¸Ðº

ÐŸÑ€Ð¾ÑÑ‚Ð¾ Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚ÑŒ 100% ÑÑ‚Ñ€Ð¾Ðº Ð½ÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ (Ð¾ÑÐ¾Ð±ÐµÐ½Ð½Ð¾ Ð² GameDev). Ð’ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ðµ Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ Ð½Ð°Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ **Ð½ÐµÐ³Ð°Ñ‚Ð¸Ð²Ð½Ñ‹Ñ… Ñ‚ÐµÑÑ‚Ð¾Ð²** Ð¸ Ñ‚ÐµÑÑ‚Ð¾Ð² Ð½Ð° ÐºÑ€Ð°ÐµÐ²Ñ‹Ðµ ÑÐ»ÑƒÑ‡Ð°Ð¸ Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚Ð¸ Ð¸ Ð»Ð¾Ð³Ð¸ÐºÐ¸. ÐšÐ°Ð¶Ð´Ð°Ñ Ð½Ð¾Ð²Ð°Ñ Ð¼ÐµÑ…Ð°Ð½Ð¸ÐºÐ° ÑÑ„Ñ„ÐµÐºÑ‚Ð¾Ð² Ð¸Ð»Ð¸ ÑÑƒÑ‰Ð½Ð¾ÑÑ‚ÐµÐ¹ Ð¾Ð±ÑÐ·Ð°Ð½Ð° ÑÐ¾Ð¿Ñ€Ð¾Ð²Ð¾Ð¶Ð´Ð°Ñ‚ÑŒÑÑ Ñ‚Ð°ÐºÐ¸Ð¼Ð¸ Ñ‚ÐµÑÑ‚Ð°Ð¼Ð¸.

### 1. Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð·Ð°Ñ‰Ð¸Ñ‚Ñ‹ Ð¾Ñ‚ Double-Triggering (Zombie Events)

Ð’Ð°Ñ Ð²ÑÐµÐ³Ð´Ð° Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð¸Ð½Ñ‚ÐµÑ€ÐµÑÐ¾Ð²Ð°Ñ‚ÑŒ Ð²Ð¾Ð¿Ñ€Ð¾Ñ: "Ð Ñ‡Ñ‚Ð¾, ÐµÑÐ»Ð¸ Ð¿Ñ€Ð¸Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ ÑÑ„Ñ„ÐµÐºÑ‚ Ðº Ð¼ÐµÑ€Ñ‚Ð²ÐµÑ†Ñƒ Ð² Ñ‚Ð¾Ð¼ Ð¶Ðµ ÐºÐ°Ð´Ñ€Ðµ, Ð´Ð¾ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ¸ GC?"
Ð¢ÐµÑÑ‚ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð½Ð°Ð±Ð¸Ñ‚ÑŒ Ð¼ÐµÑ€Ñ‚Ð²Ð¾Ð¼Ñƒ Ð²Ñ€Ð°Ð³Ñƒ ÑƒÑ€Ð¾Ð½ Ð¸ ÑƒÐ±ÐµÐ´Ð¸Ñ‚ÑŒÑÑ, Ñ‡Ñ‚Ð¾ ÑÐ¼Ð¸Ñ‚Ñ‚ÐµÑ€ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ð¹ ÑÐ¼ÐµÑ€Ñ‚Ð¸ Ð¸Ð»Ð¸ ÑÐ¿Ð°Ð²Ð½Ð° Ð»ÑƒÑ‚Ð° Ð¾Ñ‚Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð» ÑÑ‚Ñ€Ð¾Ð³Ð¾ 1 Ñ€Ð°Ð·:

```typescript
it('should trigger death strictly ONCE even on concurrent DOT ticks', () => {
    // Ð£Ð±Ð¸Ñ‚ÑŒ (hp = 0)
    // ÐŸÑ€Ð¾ÐºÑ€ÑƒÑ‚Ð¸Ñ‚ÑŒ update
    // ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ toHaveBeenCalledTimes(1)
});
```

### 2. Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð“Ð»ÑƒÐ±Ð¸Ð½Ñ‹ Ð¡Ñ‚ÐµÐºÐ° Ð’Ñ‹Ð·Ð¾Ð²Ð¾Ð² (CallStack Depth)

Ð’ÑÐµ AoE / Ð¦ÐµÐ¿Ð½Ñ‹Ðµ Ð¼Ð¾Ð»Ð½Ð¸Ð¸ / Ð’Ð·Ñ€Ñ‹Ð²Ñ‹ Ð¿Ñ€Ð¸ ÑÐ¼ÐµÑ€Ñ‚Ð¸ Ð¼Ð¾Ð³ÑƒÑ‚ Ð²Ñ‹Ð·Ð²Ð°Ñ‚ÑŒ Ñ€ÐµÐºÑƒÑ€ÑÐ¸ÑŽ (Ð²Ñ€Ð°Ð³Ð¸ ÑÑ‚Ð¾ÑÑ‚ Ð±Ð»Ð¸Ð·ÐºÐ¾ Ð´Ñ€ÑƒÐ³ Ðº Ð´Ñ€ÑƒÐ³Ñƒ Ð¸ ÑƒÐ±Ð¸Ð²Ð°ÑŽÑ‚ Ð´Ñ€ÑƒÐ³ Ð´Ñ€ÑƒÐ³Ð° Ð²Ð·Ñ€Ñ‹Ð²Ð°Ð¼Ð¸).
Ð’Ñ‹ Ð¾Ð±ÑÐ·Ð°Ð½Ñ‹ Ð½Ð°Ð¿Ð¸ÑÐ°Ñ‚ÑŒ Ñ‚ÐµÑÑ‚ Ð½Ð° ÑÐºÐ¾Ð¿Ð»ÐµÐ½Ð¸Ðµ:

```typescript
it('should safely process explosive chain reactions without crashing', () => {
    // Ð—Ð°ÑÐ¿Ð°Ð²Ð½Ð¸Ñ‚ÑŒ 20 Ð²Ñ€Ð°Ð³Ð¾Ð² Ð² ÐºÐ¾Ð¾Ñ€Ð´Ð¸Ð½Ð°Ñ‚Ðµ x:100, y:100 Ñ 1 Ð¥ÐŸ
    // ÐšÐ°Ð¶Ð´Ð¾Ð¼Ñƒ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ onDeath Ð²Ð·Ñ€Ñ‹Ð²
    // ÐÐ°Ð½ÐµÑÑ‚Ð¸ ÑƒÑ€Ð¾Ð½ Ð¾Ð´Ð½Ð¾Ð¼Ñƒ
    expect(() => collisionSystem.update()).not.toThrow();
    // ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ, Ñ‡Ñ‚Ð¾ Ð²ÑÐµ Ð¼ÐµÑ€Ñ‚Ð²Ñ‹
});
```

### 3. Ð¡Ñ‚Ñ€ÐµÑÑ-Ñ‚ÐµÑÑ‚Ñ‹ Ð½Ð° Ð°Ð»Ð»Ð¾ÐºÐ°Ñ†Ð¸Ð¸ (Multi-Stack Testing)

Ð•ÑÐ»Ð¸ Ð²Ñ‹ Ð¿Ð¸ÑˆÐµÑ‚Ðµ ÑÑ‚Ð°ÐºÐ¸Ð½Ð³ Ð°ÑƒÑ€ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, Slow), Ð¿Ñ€Ð¾Ñ‚ÐµÑÑ‚Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ ÑÑ†ÐµÐ½Ð°Ñ€Ð¸Ð¹ Ð½Ð°Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ Ð´ÐµÑÑÑ‚ÐºÐ¾Ð² ÑÑ‚Ð°ÐºÐ¾Ð², Ñ‡Ñ‚Ð¾Ð±Ñ‹ ÑƒÐ±ÐµÐ´Ð¸Ñ‚ÑŒÑÑ, Ñ‡Ñ‚Ð¾ Ð½ÐµÑ‚ ÑƒÑ‚ÐµÑ‡ÐµÐº Ð¿Ð°Ð¼ÑÑ‚Ð¸ Ð¸Ð»Ð¸ Ð½ÐµÐ»Ð¸Ð½ÐµÐ¹Ð½Ñ‹Ñ… Ð±Ð°Ð³Ð¾Ð²:

```typescript
it('should handle 100 concurrent slow applications, keeping only the max', () => {
    for (let i = 0; i < 100; i++) enemy.applySlow(...);
    expect(enemy.slowPower).toBe(expectedMax);
});
```
