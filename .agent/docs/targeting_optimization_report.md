# Отчет об Оптимизации Системы Наведения

## Цель

Устранение проблем производительности (CPU spikes) при большом количестве врагов (200+) и башен, вызванных неэффективным алгоритмом поиска целей O(N) и частыми аллокациями памяти (Garbage Collection).

## Ключевые Изменения

### 1. Spatial Grid (Пространственная Сетка)

**Файл:** `src/SpatialGrid.ts`

- **Zero-Allocation Query:** Реализован метод `queryInRadius(x, y, radius, outBuffer)`, который заполняет переданный массив `outBuffer`, вместо создания нового.
- **Поддержка крупных юнитов:** Добавлена константа `PADDING` (64px) для корректного поиска врагов, чей центр находится в соседней клетке, но тело заходит в радиус атаки.

### 2. Централизованная Система Наведения

**Файл:** `src/systems/TargetingSystem.ts` (Новый файл)

- **Статический Буфер:** Используется общий статический массив `buffer` для всех запросов, исключая аллокации.
- **Приоритет Угроз (Taunt):** Внедрена логика проверки `threatPriority`. Если в радиусе есть враг с приоритетом > 0 (например, Magma Statue), башня игнорирует остальных и атакует его.
- **Режимы Наведения:** Реализованы все стратегии (`CLOSEST`, `STRONGEST`, `FIRST`, `LAST`) с оптимизированными проверками (без `Math.sqrt`, без сортировок массивов).

### 3. Логика Башни (Tower)

**Файл:** `src/Tower.ts`

- **Ленивые Обновления (Lazy Updates):** Башня ищет новую цель только если:
  - Текущая цель погибла или вышла из радиуса.
  - Истек таймер поиска `searchTimer`.
- **Throttling (Троттлинг):** Поиск целей распределен по кадрам с помощью случайного таймера (0.15s + random), чтобы избежать пиков нагрузки в одном кадре.
- **Fix "Липкой Цели":** Башня периодически перепроверяет окружение, даже если у нее есть цель, чтобы мгновенно переключиться на высокоприоритетного врага (Taunt), если он вошел в радиус.

### 4. Интеграция в Game Loop

**Файл:** `src/scenes/GameScene.ts`

Строгий порядок обновлений для детерминированности:

1. **Move Entities**: Враги двигаются (`EntityManager`).
2. **Build Grid**: Сетка перестраивается (`CollisionSystem.prepareGrid(enemies)`). *Ограничения сетки напрямую зависят от `window.innerWidth`, что критично учитывать при тестировании JSDOM.*
3. **Targeting**: Башни ищут цели в актуальной сетке (`Tower.update(dt)`).
4. **Fire**: Оружие стреляет по выбранным целям (`WeaponSystem.update(towers, enemies, projSys)`).
5. **Move Projectiles**: Снаряды летят (`ProjectileSystem.update(dt)`).
6. **Collision Check**: Проверка попаданий (`CollisionSystem.update(projSys, enemies)`).

### 6. Phase 2: Precision & Stability (New)

**Файлы:** `src/systems/TargetingSystem.ts`, `src/Tower.ts`

- **Sub-tile Precision:** Для режимов `FIRST` и `LAST` теперь используется векторный расчет (проекция позиции врага на вектор потока `FlowField`), что дает точность до пикселя внутри клетки. Это устранило "stuttering" при выборе целей в одной клетке.
- **Hysteresis (Липкость):** Введен коэффициент `HYSTERESIS_FACTOR` (1.15). Текущая цель получает бонус к скорингу, чтобы башня не переключалась между равнозначными целями каждый кадр (anti-flicker).
- **Gated Shooting (Сектор Обстрела):**
  - Разделена логика: `Targeting` (поиск цели, 5-10Hz) и `Tracking` (визуальный поворот, 60Hz).
  - Башня стреляет только если разница углов `< firingArc`.
  - **Sniper:** Узкий сектор (0.15 rad) — требует точного наведения.
  - **Minigun:** Широкий сектор (0.6 rad) — огонь веером.
  - **Rotation:** Используется `lerpAngle` для плавного физического поворота с разной скоростью (`turnSpeed`) в зависимости от типа карты.

## Результат

- **Производительность:** Алгоритм поиска целей стал O(1) (константное время, зависящее только от плотности врагов в клетке, а не от общего количества).
- **Память:** Полностью исключены аллокации массивов в циклах стрельбы и коллизий. GC не нагружается.
- **Геймплей:**
  - "Taunt" работает корректно и отзывчиво.
  - Башни вращаются плавно и естественно.
  - Снайперы ведут себя "тяжело", пулеметы — "шустро".

---
*Документ создан агентом AntiGravity*
