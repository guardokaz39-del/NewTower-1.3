# Отчет об Оптимизации Системы Наведения

## Цель

Устранение проблем производительности (CPU spikes) при большом количестве врагов (200+) и башен, вызванных неэффективным алгоритмом поиска целей O(N) и частыми аллокациями памяти (Garbage Collection).

## Ключевые Изменения

### 1. Spatial Grid (Пространственная Сетка)

**Файл:** `src/SpatialGrid.ts`

- **Zero-Allocation Query:** Реализован метод `queryInRadius(x, y, radius, outBuffer)`, который заполняет переданный массив `outBuffer`, вместо создания нового.
- **Поддержка крупных юнитов:** Добавлена константа `PADDING` (64px) для корректного поиска врагов, чей центр находится в соседней клетке, но тело заходит в радиус атаки.

### 2. Централизованная Система Наведения

**Файл:** `src/systems/TargetingSystem.ts` (Новый файл)

- **Статический Буфер:** Используется общий статический массив `buffer` для всех запросов, исключая аллокации.
- **Приоритет Угроз (Taunt):** Внедрена логика проверки `threatPriority`. Если в радиусе есть враг с приоритетом > 0 (например, Magma Statue), башня игнорирует остальных и атакует его.
- **Режимы Наведения:** Реализованы все стратегии (`CLOSEST`, `STRONGEST`, `FIRST`, `LAST`) с оптимизированными проверками (без `Math.sqrt`, без сортировок массивов).

### 3. Логика Башни (Tower)

**Файл:** `src/Tower.ts`

- **Ленивые Обновления (Lazy Updates):** Башня ищет новую цель только если:
  - Текущая цель погибла или вышла из радиуса.
  - Истек таймер поиска `searchTimer`.
- **Throttling (Троттлинг):** Поиск целей распределен по кадрам с помощью случайного таймера (0.15s + random), чтобы избежать пиков нагрузки в одном кадре.
- **Fix "Липкой Цели":** Башня периодически перепроверяет окружение, даже если у нее есть цель, чтобы мгновенно переключиться на высокоприоритетного врага (Taunt), если он вошел в радиус.

### 4. Интеграция в Game Loop

**Файл:** `src/scenes/GameScene.ts`

Строгий порядок обновлений для детерминированности:

1. **Move Entities**: Враги двигаются (`EntityManager`).
2. **Build Grid**: Сетка перестраивается (`CollisionSystem.prepareGrid`).
3. **Targeting**: Башни ищут цели в актуальной сетке (`Tower.update`).
4. **Fire**: Оружие стреляет по выбранным целям (`WeaponSystem.update`).
5. **Move Projectiles**: Снаряды летят (`ProjectileSystem`).
6. **Collision Check**: Проверка попаданий (`CollisionSystem.update`).

### 5. Оптимизация Коллизий

**Файл:** `src/CollisionSystem.ts`

- **AOE Optimization:** Для просчета взрывов и сплэш-урона теперь используется `queryInRadius` и статический `aoeBuffer`.
- **Удалены аллокации:** Полностью убраны вызовы устаревшего `getNearby`, возвращавшего новые массивы.

## Результат

- **Производительность:** Алгоритм поиска целей стал O(1) (константное время, зависящее только от плотности врагов в клетке, а не от общего количества).
- **Память:** Полностью исключены аллокации массивов в циклах стрельбы и коллизий. GC не нагружается.
- **Геймплей:** Механика "Taunt" работает корректно и отзывчиво благодаря "Sticky Target Fix".

---
*Документ создан агентом AntiGravity*
