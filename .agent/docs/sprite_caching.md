# –°–∏—Å—Ç–µ–º–∞ –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –°–ø—Ä–∞–π—Ç–æ–≤ (Sprite Caching)

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç —Å–∏—Å—Ç–µ–º—É –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –≤—Ä–∞–≥–æ–≤ —á–µ—Ä–µ–∑ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–µ "–∑–∞–ø–µ–∫–∞–Ω–∏–µ" (baking) –∞–Ω–∏–º–∞—Ü–∏–π –≤ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Å–ø—Ä–∞–π—Ç—ã. –≠—Ç–∞ —Å–∏—Å—Ç–µ–º–∞ –∫—Ä–∏—Ç–∏—á–Ω–∞ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è —Å—Ç–∞–±–∏–ª—å–Ω—ã—Ö 60 FPS –ø—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ —é–Ω–∏—Ç–æ–≤ (300+).

## üéØ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

–°–∏—Å—Ç–µ–º–∞ —Å—Ç—Ä–æ–∏—Ç—Å—è –Ω–∞ —Ç—Ä–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö:

1. **CachedUnitRenderer**: –ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è –≤—Å–µ—Ö –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ä–µ–Ω–¥–µ—Ä–µ—Ä–æ–≤.
2. **SpriteBaker**: –£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–ø—Ä–∞–π—Ç–æ–≤ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –∏–≥—Ä—ã.
3. **AssetCache**: –•—Ä–∞–Ω–∏–ª–∏—â–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö `HTMLCanvasElement`.

---

## üõ† CachedUnitRenderer

–í–º–µ—Å—Ç–æ —Ä—É—á–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –∏ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è, —Ç–µ–ø–µ—Ä—å –Ω–æ–≤—ã–µ —Ä–µ–Ω–¥–µ—Ä–µ—Ä—ã –¥–æ–ª–∂–Ω—ã –Ω–∞—Å–ª–µ–¥–æ–≤–∞—Ç—å `CachedUnitRenderer`.

### –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –±–∞–∑–æ–≤–æ–≥–æ –∫–ª–∞—Å—Å–∞

* **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ**: –°–∞–º –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ —Å–ø—Ä–∞–π—Ç–∞ –≤ `AssetCache`.
* **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–µ–π**: –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–µ–∂–∏–º–æ–≤ `ROTATE` (–≤—Ä–∞—â–µ–Ω–∏–µ), `FLIP` (–∑–µ—Ä–∫–∞–ª–∏—Ä–æ–≤–∞–Ω–∏–µ), `DIR3` (8-—Å—Ç–æ—Ä–æ–Ω–Ω–µ–µ –¥–≤–∏–∂–µ–Ω–∏–µ, —É–ø—Ä–æ—â–µ–Ω–Ω–æ–µ –¥–æ 3 —Å–ø—Ä–∞–π—Ç–æ–≤).
* **Hybrid Rendering**: –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ (—á–∞—Å—Ç–∏—Ü—ã, —Å–≤–µ—á–µ–Ω–∏–µ) –ø–æ–≤–µ—Ä—Ö –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–ø—Ä–∞–π—Ç–∞.
* **Hit Flash**: –í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—Å–ø—ã—à–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —É—Ä–æ–Ω–∞ (`globalCompositeOperation = 'source-atop'`).

### –†–µ–∂–∏–º—ã –û—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏ (`orientationMode`)

| –†–µ–∂–∏–º | –û–ø–∏—Å–∞–Ω–∏–µ | –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ |
| :--- | :--- | :--- |
| **`ROTATE`** | –°–ø—Ä–∞–π—Ç —Ä–∏—Å—É–µ—Ç—Å—è —Å–º–æ—Ç—Ä—è—â–∏–º –≤–ø—Ä–∞–≤–æ –∏ –≤—Ä–∞—â–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `ctx.rotate`. | –ñ—É–∫–∏, –ü–∞—É–∫–∏, –ü—Ä–æ—Å—Ç—ã–µ –º–æ–Ω—Å—Ç—Ä—ã (–≤–∏–¥ —Å–≤–µ—Ä—Ö—É). |
| **`FLIP`** | –°–ø—Ä–∞–π—Ç –∏–º–µ–µ—Ç –≤–∏–¥ —Å–±–æ–∫—É. –ü—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏ –≤–ª–µ–≤–æ –∑–µ—Ä–∫–∞–ª–∏—Ç—Å—è (`scale(-1, 1)`). | –ì—É–º–∞–Ω–æ–∏–¥—ã (–û—Ä–∫–∏, –ì–æ–±–ª–∏–Ω—ã, –°–∫–µ–ª–µ—Ç—ã). |
| **`DIR3`** | 3 –Ω–∞–±–æ—Ä–∞ —Å–ø—Ä–∞–π—Ç–æ–≤: SIDE (–±–æ–∫), UP (–≤–≤–µ—Ä—Ö), DOWN (–≤–Ω–∏–∑). SIDE –∑–µ—Ä–∫–∞–ª–∏—Ç—Å—è. | –°–ª–æ–∂–Ω—ã–µ —é–Ω–∏—Ç—ã, –≥–¥–µ –≤–∞–∂–µ–Ω —Ä–∞–∫—É—Ä—Å (–¢–∞–Ω–∫–∏, –ë–æ—Å—Å—ã). |

---

## ‚öôÔ∏è –ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ –≤—Ä–∞–≥–∞

### 1. –°–æ–∑–¥–∞–π—Ç–µ –∫–ª–∞—Å—Å —Ä–µ–Ω–¥–µ—Ä–µ—Ä–∞

–ù–∞—Å–ª–µ–¥—É–π—Ç–µ—Å—å –æ—Ç `CachedUnitRenderer` –∏ —Ä–µ–∞–ª–∏–∑—É–π—Ç–µ –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π –º–µ—Ç–æ–¥ `drawFrame`.

```typescript
import { CachedUnitRenderer } from './CachedUnitRenderer';

export class MyNewEnemyRenderer extends CachedUnitRenderer {
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–µ–∂–∏–º–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ROTATE)
    protected override orientationMode = 'FLIP' as const; 

    constructor() {
        super();
        this.walkCycleMultiplier = 0.2; // –°–∫–æ—Ä–æ—Å—Ç—å –∞–Ω–∏–º–∞—Ü–∏–∏
        this.spriteSize = 96;           // –†–∞–∑–º–µ—Ä —Å–ø—Ä–∞–π—Ç–∞
    }

    /**
     * –†–∏—Å—É–µ—Ç –û–î–ò–ù –∫–∞–¥—Ä –∞–Ω–∏–º–∞—Ü–∏–∏.
     * –í—ã–∑—ã–≤–∞–µ—Ç—Å—è SpriteBaker'–æ–º –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –∏–≥—Ä—ã.
     * @param t –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è (0.0 -> 1.0) –≤–Ω—É—Ç—Ä–∏ —Ü–∏–∫–ª–∞ —Ö–æ–¥—å–±—ã
     */
    drawFrame(ctx: CanvasRenderingContext2D, enemy: Enemy, t: number): void {
        const phase = t * Math.PI * 2; // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º 0..1 –≤ —Ä–∞–¥–∏–∞–Ω—ã (0..2PI)
        
        // –†–∏—Å—É–µ–º —Ç–µ–ª–æ –≤—Ä–∞–≥–∞ –≤ —Ü–µ–Ω—Ç—Ä–µ (0,0)
        ctx.fillStyle = 'green';
        ctx.beginPath();
        ctx.arc(0, Math.sin(phase) * 5, 20, 0, Math.PI * 2); // –ü—Ä—É–∂–∏–Ω—è—â–∞—è –ø–æ—Ö–æ–¥–∫–∞
        ctx.fill();
    }
}
```

### 2. (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) DIR3 –†–µ–∂–∏–º

–ï—Å–ª–∏ –Ω—É–∂–µ–Ω `DIR3` (—Ä–∞–∑–Ω—ã–µ —Å–ø—Ä–∞–π—Ç—ã –¥–ª—è –≤–µ—Ä—Ö–∞/–Ω–∏–∑–∞):

```typescript
export class ComplexRenderer extends CachedUnitRenderer {
    protected override orientationMode = 'DIR3' as const;

    // –£–∫–∞–∑—ã–≤–∞–µ–º, –∫–∞–∫–∏–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–ø–µ–∫–∞—Ç—å
    getBakeFacings(): ('SIDE' | 'UP' | 'DOWN')[] {
        return ['SIDE', 'UP', 'DOWN'];
    }

    // –°–ø–µ—Ü–∏—Ñ–∏—á–Ω–∞—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π
    drawFrameDirectional(ctx: CanvasRenderingContext2D, enemy: Enemy, t: number, facing: string) {
        if (facing === 'UP') {
            // –†–∏—Å—É–µ–º —Å–ø–∏–Ω—É
        } else if (facing === 'DOWN') {
            // –†–∏—Å—É–µ–º –ª–∏—Ü–æ
        } else {
            this.drawFrame(ctx, enemy, t); // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –±–æ–∫
        }
    }
}
```

### 3. (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –ì–∏–±—Ä–∏–¥–Ω—ã–π –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ (Effect Layer)

–ï—Å–ª–∏ –Ω—É–∂–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ —á–∞—Å—Ç–∏—Ü—ã (–∫–∞–∫ —É Magma King), –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç–µ `drawEffects`:

```typescript
    // –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ (–∫–∞–∂–¥—ã–π –∫–∞–¥—Ä) –ü–û–í–ï–†–• —Å–ø—Ä–∞–π—Ç–∞
    protected drawEffects(ctx: CanvasRenderingContext2D, enemy: Enemy, scale: number): void {
        // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ —Ä–∏—Å–æ–≤–∞—Ç—å –ø–∞—Ä—Ç–∏–∫–ª—ã, —Å–≤–µ—á–µ–Ω–∏–µ, –ø–æ–ª–æ—Å–∫–∏ HP –∏ —Ç.–¥.
        // –í–ê–ñ–ù–û: –ù–µ –∑–∞–±—ã–≤–∞–π—Ç–µ ctx.save() / ctx.restore(), –µ—Å–ª–∏ –º–µ–Ω—è–µ—Ç–µ state
        
        ctx.save();
        // ... drawing particles ...
        ctx.restore();
    }
```

### 4. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ `Assets.ts`

–î–æ–±–∞–≤—å—Ç–µ –≤—ã–∑–æ–≤ –±—ç–∏–∫–∏–Ω–≥–∞ –≤ `Assets.generateBakedSprites()`:

```typescript
// Assets.ts
private static generateBakedSprites() {
    // ...
    SpriteBaker.bakeWalkCycle('my_new_enemy', new MyNewEnemyRenderer());
}
```

*–í–∞–∂–Ω–æ: –ø–µ—Ä–≤—ã–π –∞—Ä–≥—É–º–µ–Ω—Ç (`typeId`) –¥–æ–ª–∂–µ–Ω —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å ID –≤—Ä–∞–≥–∞ –≤ –∫–æ–Ω—Ñ–∏–≥–µ.*

---

## ‚ö° –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (Best Practices)

1. **Object Pooling**: –î–ª—è —Å–∏—Å—Ç–µ–º —á–∞—Å—Ç–∏—Ü (–∫–∞–∫ –≤ `MagmaUnitRenderer`) –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—É–ª—ã –æ–±—ä–µ–∫—Ç–æ–≤, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å GC (Garbage Collection) –ø–∞—É–∑.
2. **AssetCache.getGlow**: –ù–µ —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ –≥—Ä–∞–¥–∏–µ–Ω—Ç—ã (`createRadialGradient`) –∫–∞–∂–¥—ã–π –∫–∞–¥—Ä. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `AssetCache.getGlow('color', size)`, –∫–æ—Ç–æ—Ä—ã–π –∫—ç—à–∏—Ä—É–µ—Ç –≥—Ä–∞–¥–∏–µ–Ω—Ç –≤ –º–∞–ª–µ–Ω—å–∫—É—é —Ç–µ–∫—Å—Ç—É—Ä—É.
3. **–†–∞–∑–º–µ—Ä –°–ø—Ä–∞–π—Ç–∞**: –î–µ—Ä–∂–∏—Ç–µ `spriteSize` —Ä–∞–∑—É–º–Ω—ã–º (64-128px). –°–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∏–µ —Å–ø—Ä–∞–π—Ç—ã –∑–∞–±–∏–≤–∞—é—Ç –ø–∞–º—è—Ç—å –∏ –º–µ–¥–ª–µ–Ω–Ω–µ–µ —Ä–∏—Å—É—é—Ç—Å—è.
4. **–°–ª–æ–∂–Ω—ã–µ –∫–æ–Ω—Ç—É—Ä—ã**: –ò–∑–±–µ–≥–∞–π—Ç–µ `ctx.clip()` –≤–Ω—É—Ç—Ä–∏ `drawFrame` –µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ, —ç—Ç–æ –¥–æ—Ä–æ–≥–æ –¥–∞–∂–µ –ø—Ä–∏ –∑–∞–ø–µ–∫–∞–Ω–∏–∏.

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤–Ω–µ–¥—Ä–µ–Ω–∏—è

* –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ `CachedUnitRenderer` —Å–Ω–∏–∑–∏–ª –≤—Ä–µ–º—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –∫–∞–¥—Ä–∞ (Scripting + Rendering) —Å ~14–º—Å –¥–æ ~4–º—Å –ø—Ä–∏ 300 —é–Ω–∏—Ç–∞—Ö.
* –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –ø–æ–∑–≤–æ–ª–∏–ª —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤–∏–∑—É–∞–ª—å–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ Boss-—é–Ω–∏—Ç–æ–≤ –±–µ–∑ –ø—Ä–æ—Å–∞–¥–æ–∫ FPS.
