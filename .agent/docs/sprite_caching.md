# –°–∏—Å—Ç–µ–º–∞ –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –°–ø—Ä–∞–π—Ç–æ–≤ (Sprite Caching)

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç —Å–∏—Å—Ç–µ–º—É –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –≤—Ä–∞–≥–æ–≤ —á–µ—Ä–µ–∑ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–µ "–∑–∞–ø–µ–∫–∞–Ω–∏–µ" (baking) –∞–Ω–∏–º–∞—Ü–∏–π –≤ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Å–ø—Ä–∞–π—Ç—ã.

## üéØ –¶–µ–ª—å

–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –ø–æ–≤—ã—à–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (FPS) –ø—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –≤—Ä–∞–≥–æ–≤ (300+), –∑–∞–º–µ–Ω—è—è —Ç—è–∂–µ–ª—ã–µ –ø—Ä–æ—Ü–µ–¥—É—Ä–Ω—ã–µ –≤—ã–∑–æ–≤—ã (`ctx.fill`, `ctx.gradient`, `ctx.shadow`) –Ω–∞ –±—ã—Å—Ç—Ä—ã–π `ctx.drawImage`.

## üõ† –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. **Bake One Direction**: –ê–Ω–∏–º–∞—Ü–∏—è –∑–∞–ø–µ–∫–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è "–í–ø—Ä–∞–≤–æ" (Side View).
2. **Runtime Rotation**: –í –∏–≥—Ä–µ —Å–ø—Ä–∞–π—Ç –≤—Ä–∞—â–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `ctx.rotate()`.
3. **SpriteBaker**: –£—Ç–∏–ª–∏—Ç–∞ `src/utils/SpriteBaker.ts` —Å–æ–∑–¥–∞–µ—Ç `OffscreenCanvas` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–∞–¥—Ä–∞ –∞–Ω–∏–º–∞—Ü–∏–∏.
4. **AssetCache**: –•—Ä–∞–Ω–∏—Ç –≥–æ—Ç–æ–≤—ã–µ —Å–ø—Ä–∞–π—Ç—ã –≤ –ø–∞–º—è—Ç–∏.

## üìã –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –Æ–Ω–∏—Ç—ã

–ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ —Ç–∏–ø—ã –≤—Ä–∞–≥–æ–≤:

1. **Orc (`orc`)**: –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —é–Ω–∏—Ç.
2. **Skeleton (`skeleton`, `grunt`)**: –ú–∞—Å—Å–æ–≤—ã–π —é–Ω–∏—Ç.
3. **Goblin (`goblin`)**: –ë—ã—Å—Ç—Ä—ã–π —é–Ω–∏—Ç.
4. **Spider (`spider`)**: –°–ª–æ–∂–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –Ω–æ–≥.
5. **Troll (`troll`)**: –ö—Ä—É–ø–Ω—ã–π —é–Ω–∏—Ç.
6. **Rat (`rat`, `sapper_rat`)**: –ú–µ–ª–∫–∏–π –º–∞—Å—Å–æ–≤—ã–π —é–Ω–∏—Ç.
7. **Hellhound (`hellhound`, `scout`)**: –°–ª–æ–∂–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã –æ–≥–Ω—è.
8. **Magma King (`magma_king`)**: –ë–æ—Å—Å —Å —á–∞—Å—Ç–∏—Ü–∞–º–∏. *(–ß–∞—Å—Ç–∏—Ü—ã —Ä–∏—Å—É—é—Ç—Å—è –ø–æ–≤–µ—Ä—Ö —Å–ø—Ä–∞–π—Ç–∞)*.
9. **Flesh Colossus (`flesh_colossus`)**: –°–ª–æ–∂–Ω—ã–π –º–Ω–æ–≥–æ—Å–ª–æ–π–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥. *(–ö—ç—à–∏—Ä—É–µ—Ç—Å—è "–∑–¥–æ—Ä–æ–≤–∞—è" –≤–µ—Ä—Å–∏—è)*.

## ‚öôÔ∏è –ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ –≤—Ä–∞–≥–∞

–ß—Ç–æ–±—ã –≤–∫–ª—é—á–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –Ω–æ–≤–æ–≥–æ –∫–ª–∞—Å—Å–∞ –≤—Ä–∞–≥–∞:

1. **–†–µ–∞–ª–∏–∑—É–π—Ç–µ –º–µ—Ç–æ–¥ `drawFrame` –≤ —Ä–µ–Ω–¥–µ—Ä–µ—Ä–µ**:

    ```typescript
    // IUnitRenderer.ts
    drawFrame(ctx: CanvasRenderingContext2D, enemy: Enemy, t: number): void {
        // –†–∏—Å—É–µ—Ç –≤—Ä–∞–≥–∞ –≤ —Ü–µ–Ω—Ç—Ä–µ (0,0) –¥–ª—è –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ t (0..1)
        // –û–±—ã—á–Ω–æ –≤—ã–∑—ã–≤–∞–µ—Ç this.drawSide(ctx, ... t ...)
    }
    ```

2. **–û–±–Ω–æ–≤–∏—Ç–µ `drawBody` –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫—ç—à–∞**:

    ```typescript
    drawBody(ctx, enemy, scale, rotation) {
        // 1. –ü–æ–ø—ã—Ç–∫–∞ –Ω–∞–π—Ç–∏ —Å–ø—Ä–∞–π—Ç
        const t = ...; // –í—ã—á–∏—Å–ª–∏—Ç—å —Ñ–∞–∑—É –∞–Ω–∏–º–∞—Ü–∏–∏
        const frameKey = `unit_${enemy.typeId}_walk_${frameIdx}`;
        const sprite = Assets.get(frameKey);

        if (sprite) {
            ctx.drawImage(sprite, ...);
            return;
        }

        // 2. –§–æ–ª–ª–±—ç–∫ (–ü—Ä–æ—Ü–µ–¥—É—Ä–Ω–∞—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∞)
        this.drawProcedural(...);
    }
    ```

3. **–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ –≤ `Assets.ts`**:
    –í –º–µ—Ç–æ–¥ `generateBakedSprites()` –¥–æ–±–∞–≤—å—Ç–µ:

    ```typescript
    SpriteBaker.bakeWalkCycle('new_enemy_id', new NewEnemyRenderer());
    ```

    *–í–∞–∂–Ω–æ: `new_enemy_id` –¥–æ–ª–∂–µ–Ω —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å —Ç–µ–º, —á—Ç–æ –∏—â–µ—Ç —Ä–µ–Ω–¥–µ—Ä–µ—Ä (–æ–±—ã—á–Ω–æ `enemy.typeId`).*

## ‚ö†Ô∏è –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

* **–ü–∞–º—è—Ç—å**: –ö–∞–∂–¥—ã–π —é–Ω–∏—Ç –∑–∞–Ω–∏–º–∞–µ—Ç ~3MB –≤–∏–¥–µ–æ–ø–∞–º—è—Ç–∏ (32 –∫–∞–¥—Ä–∞ * 96x96px). –ù–µ –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª—è—Ç—å –¥–ª—è —Ä–µ–¥–∫–∏—Ö —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –≤—Ä–∞–≥–æ–≤.
* **–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ —ç—Ñ—Ñ–µ–∫—Ç—ã**: –≠—Ñ—Ñ–µ–∫—Ç—ã, –∑–∞–≤–∏—Å—è—â–∏–µ –æ—Ç —Ä–∞–Ω–¥–æ–º–∞ (—á–∞—Å—Ç–∏—Ü—ã, –º–æ–ª–Ω–∏–∏), —Å–ª–µ–¥—É–µ—Ç —Ä–∏—Å–æ–≤–∞—Ç—å –ø—Ä–æ—Ü–µ–¥—É—Ä–Ω–æ –ü–û–í–ï–†–• —Å–ø—Ä–∞–π—Ç–∞ (–∫–∞–∫ —É Magma King).
* **–ü–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è**: –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–π (–∫—Ä–æ–≤—å, —Ç—Ä–µ—â–∏–Ω—ã) –ª–∏–±–æ –Ω–µ –∫—ç—à–∏—Ä—É–µ—Ç—Å—è (—Ñ–æ–ª–ª–±—ç–∫ –Ω–∞ –ø—Ä–æ—Ü–µ–¥—É—Ä–∫—É –ø—Ä–∏ HP < 50%), –ª–∏–±–æ —Ä–∏—Å—É–µ—Ç—Å—è –ø–æ–≤–µ—Ä—Ö.

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

* –°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ CPU Render Thread –Ω–∞ **60-80%**.
* –°—Ç–∞–±–∏–ª—å–Ω—ã–µ 60 FPS –ø—Ä–∏ 300+ —é–Ω–∏—Ç–æ–≤ –Ω–∞ —ç–∫—Ä–∞–Ω–µ.
